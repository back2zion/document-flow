<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문서 파일 처리 흐름도 - R&R 구분</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow: hidden;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .flow-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }
        .process-box {
            position: relative;
            width: 100%;
            margin-bottom: 40px;
        }
        .process-step {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            margin-bottom: 20px;
        }
        .step-title {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            width: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .step-title.neoali {
            background-color: #9b59b6;
        }
        .step-title.datastreams {
            background-color: #e67e22;
        }
        .step-details {
            flex: 1;
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 12px 20px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .step-details.neoali {
            border-left: 4px solid #9b59b6;
        }
        .step-details.datastreams {
            border-left: 4px solid #e67e22;
        }
        .arrow {
            position: relative;
            width: 100%;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px 0;
        }
        .arrow::after {
            content: "";
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #3498db;
        }
        .layer-box {
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            background-color: #f8f9fa;
        }
        .layer-box.neoali {
            border-color: #9b59b6;
            background-color: #f4f0f7;
        }
        .layer-box.datastreams {
            border-color: #e67e22;
            background-color: #fdf2e9;
        }
        .layer-title {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        .layer-title.neoali {
            color: #9b59b6;
        }
        .layer-title.datastreams {
            color: #e67e22;
        }
        .process-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .process-item {
            flex: 1;
            background-color: white;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 0 10px;
            min-width: 180px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border-left: 3px solid #2ecc71;
        }
        .process-item.exclude {
            border-left: 3px solid #e74c3c;
        }
        .process-item.neoali {
            border-left: 3px solid #9b59b6;
        }
        .process-item.datastreams {
            border-left: 3px solid #e67e22;
        }
        .decision {
            background-color: #f39c12;
            color: white;
            padding: 12px 15px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .flow-arrow {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        .flow-arrow::before {
            content: "";
            flex-grow: 1;
            height: 2px;
            background-color: #3498db;
            margin-right: 10px;
        }
        .flow-arrow::after {
            content: "";
            width: 0;
            height: 0;
            border-left: 8px solid #3498db;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }
        .flow-arrow.datastreams::before {
            background-color: #e67e22;
        }
        .flow-arrow.datastreams::after {
            border-left: 8px solid #e67e22;
        }
        .parallel-flows {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .flow-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 15px;
            position: relative;
        }
        .flow-column:not(:last-child)::after {
            content: "";
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: #e0e0e0;
        }
        .note {
            background-color: #fffacd;
            border-left: 4px solid #f1c40f;
            padding: 12px 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-style: italic;
        }
        .company-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        .neoali-badge {
            background-color: #9b59b6;
            color: white;
        }
        .datastreams-badge {
            background-color: #e67e22;
            color: white;
        }
        .tech-box {
            background-color: #f1f9f7;
            border: 2px solid #2ecc71;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .tech-item {
            margin-bottom: 8px;
            padding-left: 18px;
            position: relative;
        }
        .tech-item::before {
            content: "→";
            position: absolute;
            left: 0;
            color: #2ecc71;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ex-GPT 프로젝트 문서 처리 흐름도 (R&R 구분)</h1>
        
        <div class="flow-container">
            <!-- 최초 업로드 -->
            <div class="process-box">
                <div class="process-step">
                    <div class="step-title">시작</div>
                    <div class="step-details">사용자가 다양한 문서 파일(HWP, HWPX, DOC, DOCX, PPT, PPTX, TXT, XLS, XLSX 등)을 시스템에 업로드</div>
                </div>
            </div>
            
            <div class="arrow"></div>
            
            <!-- 1단계: 문서 파싱 & 추출 (NeoAli) -->
            <div class="layer-box neoali">
                <div class="layer-title neoali">1단계: 문서 파싱 & 텍스트 추출<span class="neoali-badge">NeoAli 담당</span></div>
                
                <div class="process-group">
                    <div class="process-item neoali">
                        <h3>📄 파일 수신 및 검증</h3>
                        <p>MinIO에서 업로드된 파일 수신</p>
                        <p>파일 형식 및 크기 검증</p>
                        <p>지원 형식: HWP, HWPX, DOC, DOCX, PDF, TXT, XLS, XLSX</p>
                    </div>
                    
                    <div class="process-item neoali">
                        <h3>🔧 하이브리드 파서 실행</h3>
                        <p>스트림 방식으로 메모리에서 직접 처리</p>
                        <p>파일별 전용 파서 적용</p>
                        <p>로컬 다운로드 없이 텍스트 추출</p>
                    </div>
                    
                    <div class="process-item neoali">
                        <h3>📤 결과물 전달</h3>
                        <p><strong>추출된 순수 텍스트를</strong></p>
                        <p><strong>DataStreams에게 전달</strong></p>
                        <p>메타데이터와 함께 구조화된 형태로 제공</p>
                    </div>
                </div>
            </div>
            
            <div class="flow-arrow datastreams"></div>
            
            <!-- 2단계: 전처리 & 보안 레이어 (DataStreams) -->
            <div class="layer-box datastreams">
                <div class="layer-title datastreams">2단계: 전처리 & 보안 레이어<span class="datastreams-badge">DataStreams 담당</span></div>
                
                <div class="process-group">
                    <div class="process-item datastreams">
                        <h3>📥 텍스트 수신 및 전처리</h3>
                        <p><strong>NeoAli에서 전달받은 추출 텍스트 처리</strong></p>
                        <p>텍스트 정규화 및 클리닝</p>
                        <p>구조화된 데이터 형태로 변환</p>
                    </div>
                    
                    <div class="process-item datastreams">
                        <h3>🔍 중복 검사</h3>
                        <p><strong>추출된 텍스트를 이용한 중복 검사</strong></p>
                        <p>벡터 임베딩 기반 유사도 비교</p>
                        <p>기존 Qdrant DB 문서들과 비교 분석</p>
                    </div>
                    
                    <div class="process-item datastreams">
                        <h3>🛡️ 개인정보 검출</h3>
                        <p><strong>추출된 텍스트에서 개인정보 스캔</strong></p>
                        <p>Presidio 라이브러리 활용</p>
                        <p>현재: 검출 시 자동 삭제</p>
                        <p>향후: Human-in-the-Loop 적용</p>
                    </div>
                </div>
                
                <div class="flow-arrow"></div>
                
                <!-- 분기 처리 -->
                <div class="process-group">
                    <div class="process-item datastreams">
                        <div class="decision">👤</div>
                        <h3>관리자 업로드</h3>
                        <p>배치 처리로 대량 업로드 지원</p>
                        <p>영구 저장 (관리도구 완성 후 승인 시스템 적용)</p>
                    </div>
                    
                    <div class="process-item datastreams">
                        <div class="decision">✓</div>
                        <h3>사용자 업로드</h3>
                        <p>실시간 처리</p>
                        <p>질의응답 완료 후 자동 삭제</p>
                    </div>
                </div>
            </div>
            
            <div class="flow-arrow datastreams"></div>
            
            <div class="flow-arrow neoali"></div>
            
            <!-- 3단계: RAG 처리 레이어 (NeoAli) -->
            <div class="layer-box neoali">
                <div class="layer-title neoali">3단계: RAG 처리 레이어<span class="neoali-badge">NeoAli 담당</span></div>
                
                <div class="parallel-flows">
                    <div class="flow-column">
                        <div class="process-item neoali">
                            <h3>📄 정제된 텍스트 수신</h3>
                            <p>DataStreams에서 전처리 완료된 텍스트</p>
                        </div>
                        
                        <div class="flow-arrow"></div>
                        
                        <div class="process-item neoali">
                            <h3>✂️ 청킹</h3>
                            <p>문서를 의미 있는 단위로 분할</p>
                        </div>
                        
                        <div class="flow-arrow"></div>
                        
                        <div class="process-item neoali">
                            <h3>🔢 임베딩 생성</h3>
                            <p>vLLM-embeddings 서버 (포트 8100)</p>
                            <p>Qwen3-Embedding-0.6B 모델 사용</p>
                        </div>
                        
                        <div class="flow-arrow"></div>
                        
                        <div class="process-item neoali">
                            <h3>🏆 리랭킹</h3>
                            <p>BGE Reranker 서버 (포트 8101)</p>
                            <p>BAAI/bge-reranker-v2-m3 모델 사용</p>
                        </div>
                        
                        <div class="flow-arrow"></div>
                        
                        <div class="process-item neoali">
                            <h3>💾 벡터 저장</h3>
                            <p>Qdrant 벡터 DB에 저장 (포트 6333)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- R&R 요약 -->
            <div class="layer-box">
                <div class="layer-title">🎯 R&R 요약</div>
                
                <div class="process-group">
                    <div class="process-item neoali">
                        <h3>🔵 NeoAli 책임 영역</h3>
                        <ul style="text-align: left; font-size: 0.9em;">
                            <li><strong>문서 파싱 & 텍스트 추출</strong></li>
                            <li><strong>RAG 처리 레이어 (청킹, 임베딩, 벡터저장)</strong></li>
                        </ul>
                    </div>
                    
                    <div class="process-item datastreams">
                        <h3>🟡 DataStreams 책임 영역</h3>
                        <ul style="text-align: left; font-size: 0.9em;">
                            <li><strong>전처리 & 보안 레이어</strong></li>
                            <li><strong>중복 검사 및 개인정보 검출</strong></li>
                            <li>기존 WiseNut 시스템 운영 (8B/70B)</li>
                            <li>내부망 보안 및 인프라 관리</li>
                            <li>레거시 시스템 연계 (DB/NAS)</li>
                            <li>사용자 권한 및 보안 체계</li>
                            <li>Qwen3 대형 모델 구동 (32B/235B)</li>
                            <li>AI 모델 최적화 및 추론 서비스</li>
                            <li>멀티모달 기능 (STT/이미지)</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 프로세스 흐름 명확화 -->
            <div class="note">
                <p><strong>🔄 프로세스 흐름:</strong></p>
                <p>1. <strong>NeoAli</strong>가 문서 파싱하여 순수 텍스트 추출</p>
                <p>2. 추출된 텍스트를 <strong>DataStreams</strong>에게 전달</p>
                <p>3. <strong>DataStreams</strong>가 중복검사와 개인정보 검출 수행</p>
                <p>4. 정제된 텍스트를 <strong>NeoAli</strong>에게 다시 전달</p>
                <p>5. <strong>NeoAli</strong>가 RAG 파이프라인으로 벡터화 및 저장</p>
            </div>
                
                <div class="tech-box">
                    <h3 style="margin-top: 0;">⚡ 빠른 시작</h3>
                    
                    <div class="process-group">
                        <div class="process-item">
                            <h4>1. 환경 설정</h4>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; text-align: left; font-size: 0.8em; overflow-x: auto;">
# .env 파일 생성
HF_TOKEN=your_huggingface_token
# 운영용 (DataStreams 신규 시스템)
CHAT_MODEL_ENDPOINT=http://vllm:8000/v1
CHAT_MODEL_NAME=default-model  # Qwen3-32B 또는 Qwen3-235B
# 기존 시스템 (NeoAli WiseNut)
# LEGACY_WISENUT_8B=http://localhost:8082/v1
# LEGACY_WISENUT_70B=http://localhost:8081/v1
# 개발/테스트용 (Together.xyz 백업)
# CHAT_MODEL_ENDPOINT=https://api.together.xyz/v1
# CHAT_MODEL_NAME=Qwen/Qwen3-235B-A22B-fp8-tput
# MODEL_SERVER_API_KEY=your_together_api_key
# 로컬 서비스
EMBEDDING_MODEL_ENDPOINT=http://vllm-embeddings:8000/v1
RERANK_MODEL_ENDPOINT=http://vllm-rerank:8000/v1
QDRANT_URL=http://qdrant:6333
ENABLE_RERANK=1</pre>
                        </div>
                        
                        <div class="process-item">
                            <h4>2. Docker 실행</h4>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; text-align: left; font-size: 0.8em; overflow-x: auto;">
# 개발환경 (모든 서비스 한 서버)
docker-compose pull
docker-compose up -d

# 테스트 실행
docker compose up --abort-on-container-exit test_runner</pre>
                        </div>
                    </div>
                    
                    <div class="process-group">
                        <div class="process-item">
                            <h4>3. 프로덕션 배포</h4>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; text-align: left; font-size: 0.8em; overflow-x: auto;">
# API 서버용
docker-compose -f docker-compose-api-server.yaml up -d

# 모델 서버용 (H100 GPU)
docker-compose -f docker-compose-model-server.yaml up -d</pre>
                        </div>
                        
                        <div class="process-item">
                            <h4>4. 접근 URL</h4>
                            <ul style="text-align: left; font-size: 0.9em;">
                                <li><strong>Swagger API:</strong> <code>http://localhost:8080/docs</code></li>
                                <li><strong>Dev GUI:</strong> <code>http://localhost:8081</code></li>
                                <li><strong>MinIO Console:</strong> <code>http://localhost:9090</code></li>
                                <li><strong>Qdrant Dashboard:</strong> <code>http://localhost:6333/dashboard</code></li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="tech-box">
                    <h3 style="margin-top: 0;">📡 API 엔드포인트</h3>
                    
                    <div class="process-group">
                        <div class="process-item">
                            <h4>Chat Completion</h4>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; text-align: left; font-size: 0.8em; overflow-x: auto;">
POST /v1/chat/completions
Content-Type: application/json

{
  "model": "default-model",
  "messages": [
    {"role": "system", "content": "한국도로공사 ex-GPT 시스템입니다. Qwen3-32B 모델로 구동 중입니다."},
    {"role": "user", "content": "사용자 질문"}
  ],
  "temperature": 0.7,
  "max_tokens": 4000
}</pre>
                        </div>
                        
                        <div class="process-item">
                            <h4>Embeddings</h4>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; text-align: left; font-size: 0.8em; overflow-x: auto;">
POST /v1/embeddings
Content-Type: application/json

{
  "input": "임베딩할 텍스트",
  "model": "default-model"
}</pre>
                        </div>
                    </div>
                    
                    <div class="process-group">
                        <div class="process-item">
                            <h4>Document Ingest</h4>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; text-align: left; font-size: 0.8em; overflow-x: auto;">
# 실제로는 통합 워크플로우로 처리됨
# 파일 업로드 후 자동으로 처리되는 프로세스:

1. 문서 업로드 → MinIO 저장
2. 텍스트 추출 → Knowledge Parser
3. 전처리 → 중복검사, 개인정보 검출
4. 벡터화 → Embedding + Reranking
5. 저장 → Qdrant Vector DB

# 개발자는 OpenAI 호환 API만 사용하면 됨</pre>
                        </div>
                        
                        <div class="process-item">
                            <h4>응답 형식</h4>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; text-align: left; font-size: 0.8em; overflow-x: auto;">
# 성공 응답
{
  "status": "success",
  "document_id": "doc_12345",
  "processing_status": "completed|pending|failed"
}

# 오류 응답
{
  "status": "error",
  "error_code": "INVALID_FORMAT",
  "message": "지원하지 않는 파일 형식입니다"
}</pre>
                        </div>
                    </div>
                </div>
                
                <div class="tech-box">
                    <h3 style="margin-top: 0;">🔧 개발 팁</h3>
                    
                    <div class="process-group">
                        <div class="process-item">
                            <h4>💡 모델 교체</h4>
                            <ul style="text-align: left; font-size: 0.9em;">
                                <li>환경변수로 모델 변경 가능</li>
                                <li><code>DEFAULT_EMBEDDINGS_MODEL</code>: 임베딩 모델</li>
                                <li><code>DEFAULT_RERANK_MODEL</code>: 리랭크 모델</li>
                                <li>Hugging Face 라이선스 확인 필수</li>
                            </ul>
                        </div>
                        
                        <div class="process-item">
                            <h4>🐛 디버깅</h4>
                            <ul style="text-align: left; font-size: 0.9em;">
                                <li><code>docker logs container_name</code>: 로그 확인</li>
                                <li><code>docker compose ps</code>: 서비스 상태</li>
                                <li>GPU 메모리: <code>nvidia-smi</code></li>
                                <li>API 테스트: Swagger UI 활용</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="process-group">
                        <div class="process-item">
                            <h4>⚠️ 주의사항</h4>
                            <ul style="text-align: left; font-size: 0.9em;">
                                <li>H100 GPU: CUDA 12.8 호환성 확인</li>
                                <li>**R&R 분리**: NeoAli(기존/보안) + DataStreams(신규/AI)</li>
                                <li>포트 충돌 주의: 8080(신규 API), 8082(기존 WiseNut)</li>
                                <li>대형 모델: 32B/235B 모델은 다중 GPU 병렬 처리 필요</li>
                            </ul>
                        </div>
                        
                        <div class="process-item">
                            <h4>📊 모니터링</h4>
                            <ul style="text-align: left; font-size: 0.9em;">
                                <li>API 응답시간: Swagger UI에서 확인</li>
                                <li>Qdrant 벡터 수: Dashboard에서 확인</li>
                                <li>MinIO 파일 수: Console에서 확인</li>
                                <li>GPU 사용률: <code>watch nvidia-smi</code></li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="note">
                    <p><strong>📚 추가 문서:</strong> 자세한 API 명세는 서버 실행 후 <code>http://localhost:8080/docs</code>에서 Swagger UI를 통해 확인할 수 있습니다. 개발 중 문제가 발생하면 <code>docker logs</code>를 통해 각 서비스의 로그를 확인하세요.</p>
                </div>
            </div>
            
        </div>
    </div>
</body>
</html>
